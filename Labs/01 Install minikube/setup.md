## <font color='red'> 1.1 K8s Cluster </font>
Lab demonstrates a possible GitOps workflow using Argo CD and Tekton. We are using Argo CD to setup our Kubernetes clusters dev and prod (in the following we will only use the dev cluster) and Tekton to build and update our example application.

In this lab we're going to:
* install Dev minikube cluster
* enable Ingress controller
* install ArgoCD

---

#### <font color='red'>IMPORTANT:</font> 
<strong>Please ensure you start with a clean environment. 
If you have previously run minikube, you will need to delete the existing instance.</strong>

to stop  minikube:
```
minikube stop
```
to delete  minikube:
```
minikube delete
```

---

Pre-requisties:
* Kustomize is a standalone tool to customize Kubernetes objects through a kustomization file. Since 1.14, Kubectl also supports the management of Kubernetes objects using a kustomization file.

ensure kustomize has been installed:
```
sudo snap install kustomize 
```

* Helm is a package manager for Kubernetes that allows developers and operators to more easily package, configure, and deploy applications and services onto Kubernetes clusters.
ensure helm is installed:
```
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
```
change permission so can execute:
```
chmod 700 get_helm.sh
```
install helm:
```
./get_helm.sh
```

* GitOps is a way to do Kubernetes cluster management and application delivery.  It works by using Git as a single source of truth for declarative infrastructure and applications. With GitOps, the use of software agents can alert on any divergence between Git with what's running in a cluster, and if there's a difference, Kubernetes reconcilers automatically update or rollback the cluster depending on the case. With Git at the center of your delivery pipelines, developers use familiar tools to make pull requests to accelerate and simplify both application deployments and operations tasks to Kubernetes.

you will require a GitHub account.

* Docker Hub


---

#### <font color='red'>1.1.1  Install Dev minikube Cluster + Ingress </font>

start minikube:
```
minikube start --driver=docker --cpus=4 --memory=8192m --profile=dev
```
enable nginx controller:
```
minikube addons enable ingress --profile=dev
```
add our Ingresses to the /etc/hosts file:
```
sudo echo "`minikube ip --profile=dev` argocd-dev.fake grafana-dev.fake prometheus-dev.fake tekton-dev.fake server-dev.fake" | sudo tee -a /etc/hosts
```


#### <font color='red'>1.1.2  Install ArgoCD </font>

install ArgoCD:
```
kustomize build clusters/argocd/dev | k apply -f -
```
Note: this will take a few minutes...

verfiy ArgoCD:
```
kubectl get pods -n argocd
```
To deploy our manifests to the cluster we are using the app of apps pattern. For that we have to create a new Application, which manages all other applications (including Argo CD):
```
kubectl apply -f clusters/apps/dev.yaml
```

browse to ArgoCD > http://argocd-dev.fake

user: admin

initial password is autogenerated:
```
kubectl get pods -n argocd -l app.kubernetes.io/name=argocd-server -o name | cut -d'/' -f 2
```
Note: In the UI of Argo CD we can now see all deployed applications:

---

#### <font color='red'>1.1.2  Install ArgoCD </font>
* Deploys the Prometheus Stack via the kube-prometheus-stack Helm chart.

* Prometheus is available at prometheus-dev.fake and Grafana at grafana-dev.fake

log into Prometheus:

 > http://prometheus-dev.fake

log into Grafana:

 > http://grafana-dev.fake

 user: admin
 password: admin

 import the example Dashboard for Argo CD:
```
 https://github.com/argoproj/argo-cd/blob/master/examples/dashboard.json
```

---

#### <font color='red'>1.1.3  Install Tekton </font>
We are using Tekton Pipelines to build our example application and to update the deployed Docker image. The required tasks and pipelines are deployed by Argo CD, but we have to manually provide the credentials for Docker Hub and GitHub. 

create the secrets:

kubectl create secret docker-registry docker-registry-secret --docker-server="https://index.docker.io/v1/" --docker-username=<DOCKER_USERNAME> --docker-password=<DOCKER_PASSWORD>
kubectl annotate secret docker-registry-secret tekton.dev/docker-0=https://index.docker.io/v1/
kubectl create secret generic github-secret --type="kubernetes.io/basic-auth" --from-literal=username=<GITHUB_USERNAME> --from-literal=password=<GITHUB_PASSWORD>
kubectl annotate secret github-secret tekton.dev/git-0=https://github.com